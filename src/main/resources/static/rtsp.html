<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTSP to WebRTC Player</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 {
            text-align: center;
            color: #00d4ff;
            margin-bottom: 30px;
        }
        .input-section {
            background: #16213e;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .input-group label {
            font-weight: bold;
            color: #00d4ff;
            min-width: 100px;
        }
        .input-group input {
            flex: 1;
            min-width: 300px;
            padding: 12px 15px;
            font-size: 14px;
            border: 2px solid #0f3460;
            border-radius: 6px;
            background: #0f0f23;
            color: #eee;
        }
        .input-group input:focus {
            outline: none;
            border-color: #00d4ff;
        }
        .preset-buttons {
            margin-top: 15px;
        }
        .preset-buttons span {
            color: #888;
            margin-right: 10px;
        }
        .preset-btn {
            padding: 6px 12px;
            margin: 3px;
            font-size: 12px;
            background: #0f3460;
            border: none;
            border-radius: 4px;
            color: #eee;
            cursor: pointer;
        }
        .preset-btn:hover {
            background: #1a4a7a;
        }
        .controls {
            text-align: center;
            margin: 25px 0;
        }
        button {
            padding: 12px 35px;
            margin: 0 10px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        #playBtn {
            background: #00d4ff;
            color: #1a1a2e;
        }
        #playBtn:hover {
            background: #00b8e6;
        }
        #stopBtn {
            background: #e94560;
            color: white;
        }
        #stopBtn:hover {
            background: #d63050;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .video-section {
            display: flex;
            justify-content: center;
        }
        .video-container {
            background: #16213e;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .video-container h3 {
            margin: 0 0 15px 0;
            color: #00d4ff;
            text-align: center;
        }
        video {
            width: 960px;
            max-width: 100%;
            height: auto;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 8px;
        }
        .status {
            text-align: center;
            padding: 12px;
            border-radius: 6px;
            margin: 20px 0;
            font-weight: bold;
        }
        .status.connected {
            background: rgba(0, 212, 100, 0.2);
            color: #00d464;
        }
        .status.disconnected {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
        }
        .status.connecting {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
        .status.playing {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
        }
        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .stat-item {
            background: #16213e;
            padding: 15px 25px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-item .label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        .stat-item .value {
            font-size: 18px;
            font-weight: bold;
            color: #00d4ff;
        }
        .log {
            background: #0f0f23;
            padding: 15px;
            border-radius: 8px;
            height: 180px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        .log-entry {
            margin: 4px 0;
            padding: 3px 0;
            border-bottom: 1px solid #222;
        }
        .log-entry.error { color: #e94560; }
        .log-entry.success { color: #00d464; }
        .log-entry.info { color: #00d4ff; }
        .log-entry.warn { color: #ffc107; }

        .nav {
            text-align: center;
            margin-bottom: 20px;
        }
        .nav a {
            color: #00d4ff;
            margin: 0 15px;
            text-decoration: none;
        }
        .nav a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="nav">
        <a href="index.html">üìπ WebRTC Î£®ÌîÑÎ∞± ÌÖåÏä§Ìä∏</a>
        <a href="rtsp.html">üì∫ RTSP ÌîåÎ†àÏù¥Ïñ¥</a>
    </div>

    <h1>üì∫ RTSP to WebRTC Player</h1>
    
    <div class="input-section">
        <div class="input-group">
            <label for="rtspUrl">RTSP URL:</label>
            <input type="text" id="rtspUrl" 
                   placeholder="rtsp://username:password@192.168.1.100:554/stream1"
                   value="">
        </div>
        <div class="preset-buttons">
            <span>ÌÖåÏä§Ìä∏ Ïä§Ìä∏Î¶º:</span>
            <button class="preset-btn" onclick="setPreset('rtsp://wowzaec2demo.streamlock.net/vod/mp4:BigBuckBunny_115k.mp4')">
                Wowza Demo
            </button>
            <button class="preset-btn" onclick="setPreset('rtsp://demo:demo@ipvmdemo.dyndns.org:5541/onvif-media/media.amp?profile=profile_1_h264&sessiontimeout=60&streamtype=unicast')">
                IPVM Demo
            </button>
        </div>
    </div>

    <div id="status" class="status disconnected">Ïó∞Í≤∞ ÏïàÎê®</div>
    
    <div class="controls">
        <button id="playBtn" onclick="play()">‚ñ∂ Ïû¨ÏÉù</button>
        <button id="stopBtn" onclick="stop()" disabled>‚èπ Ï†ïÏßÄ</button>
    </div>

    <div class="stats">
        <div class="stat-item">
            <div class="label">Ïó∞Í≤∞ ÏÉÅÌÉú</div>
            <div class="value" id="connState">-</div>
        </div>
        <div class="stat-item">
            <div class="label">ICE ÏÉÅÌÉú</div>
            <div class="value" id="iceState">-</div>
        </div>
        <div class="stat-item">
            <div class="label">Ïû¨ÏÉù ÏãúÍ∞Ñ</div>
            <div class="value" id="playTime">00:00</div>
        </div>
    </div>

    <div class="video-section">
        <div class="video-container">
            <h3>üé¨ RTSP Ïä§Ìä∏Î¶º</h3>
            <video id="videoPlayer" autoplay playsinline></video>
        </div>
    </div>
    
    <div class="log" id="log"></div>

    <script>
        const videoPlayer = document.getElementById('videoPlayer');
        const rtspUrlInput = document.getElementById('rtspUrl');
        const playBtn = document.getElementById('playBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusDiv = document.getElementById('status');
        const logDiv = document.getElementById('log');
        const connStateDiv = document.getElementById('connState');
        const iceStateDiv = document.getElementById('iceState');
        const playTimeDiv = document.getElementById('playTime');

        let ws;
        let pc;
        let playStartTime;
        let playTimeInterval;

        const wsUrl = `ws://${window.location.hostname}:${window.location.port}/rtsp`;

        function setPreset(url) {
            rtspUrlInput.value = url;
        }

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function setStatus(text, type) {
            statusDiv.textContent = text;
            statusDiv.className = `status ${type}`;
        }

        function updatePlayTime() {
            if (playStartTime) {
                const elapsed = Math.floor((Date.now() - playStartTime) / 1000);
                const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const secs = (elapsed % 60).toString().padStart(2, '0');
                playTimeDiv.textContent = `${mins}:${secs}`;
            }
        }

        async function play() {
            const rtspUrl = rtspUrlInput.value.trim();
            if (!rtspUrl) {
                alert('RTSP URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }

            try {
                setStatus('Ïó∞Í≤∞ Ï§ë...', 'connecting');
                log(`RTSP Ïä§Ìä∏Î¶º Ïó∞Í≤∞: ${rtspUrl}`);

                // WebSocket Ïó∞Í≤∞
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    log('WebSocket Ïó∞Í≤∞Îê®', 'success');
                    startWebRtc(rtspUrl);
                };

                ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    log(`Î©îÏãúÏßÄ ÏàòÏã†: ${message.id}`);

                    switch (message.id) {
                        case 'startResponse':
                            handleStartResponse(message);
                            break;
                        case 'iceCandidate':
                            handleRemoteIceCandidate(message);
                            break;
                        case 'streamEnded':
                            log('Ïä§Ìä∏Î¶ºÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.', 'warn');
                            setStatus('Ïä§Ìä∏Î¶º Ï¢ÖÎ£å', 'disconnected');
                            break;
                        case 'error':
                            log(`ÏóêÎü¨: ${message.message}`, 'error');
                            setStatus('ÏóêÎü¨ Î∞úÏÉù', 'disconnected');
                            break;
                    }
                };

                ws.onerror = (error) => {
                    log(`WebSocket ÏóêÎü¨`, 'error');
                    setStatus('Ïó∞Í≤∞ ÏóêÎü¨', 'disconnected');
                };

                ws.onclose = () => {
                    log('WebSocket Ïó∞Í≤∞ Ï¢ÖÎ£å');
                };

                playBtn.disabled = true;
                stopBtn.disabled = false;

            } catch (error) {
                log(`Ïû¨ÏÉù ÏóêÎü¨: ${error.message}`, 'error');
                setStatus('ÏóêÎü¨ Î∞úÏÉù', 'disconnected');
            }
        }

        async function startWebRtc(rtspUrl) {
            log('WebRTC Ïó∞Í≤∞ ÏãúÏûë...');

            pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            });

            // ÏõêÍ≤© Ìä∏Îûô ÏàòÏã† (RTSP ÏòÅÏÉÅ)
            pc.ontrack = (event) => {
                log('ÎπÑÎîîÏò§ Ìä∏Îûô ÏàòÏã†', 'success');
                videoPlayer.srcObject = event.streams[0];
                setStatus('Ïû¨ÏÉù Ï§ë', 'playing');
                
                // Ïû¨ÏÉù ÏãúÍ∞Ñ Ïπ¥Ïö¥ÌÑ∞ ÏãúÏûë
                playStartTime = Date.now();
                playTimeInterval = setInterval(updatePlayTime, 1000);
            };

            // ICE ÌõÑÎ≥¥ Ï†ÑÏÜ°
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    sendMessage({
                        id: 'onIceCandidate',
                        candidate: event.candidate
                    });
                }
            };

            pc.onconnectionstatechange = () => {
                connStateDiv.textContent = pc.connectionState;
                log(`Ïó∞Í≤∞ ÏÉÅÌÉú: ${pc.connectionState}`);
            };

            pc.oniceconnectionstatechange = () => {
                iceStateDiv.textContent = pc.iceConnectionState;
                log(`ICE ÏÉÅÌÉú: ${pc.iceConnectionState}`);
                
                if (pc.iceConnectionState === 'connected') {
                    setStatus('Ïó∞Í≤∞Îê®', 'connected');
                } else if (pc.iceConnectionState === 'failed') {
                    setStatus('Ïó∞Í≤∞ Ïã§Ìå®', 'disconnected');
                }
            };

            // ÎπÑÎîîÏò§ ÏàòÏã†ÏùÑ ÏúÑÌïú Ìä∏ÎûúÏãúÎ≤Ñ Ï∂îÍ∞Ä
            pc.addTransceiver('video', { direction: 'recvonly' });
            pc.addTransceiver('audio', { direction: 'recvonly' });

            // SDP Offer ÏÉùÏÑ±
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            log('SDP Offer Ï†ÑÏÜ°');

            sendMessage({
                id: 'start',
                rtspUrl: rtspUrl,
                sdpOffer: offer.sdp
            });
        }

        async function handleStartResponse(message) {
            log('SDP Answer ÏàòÏã†', 'success');
            await pc.setRemoteDescription(new RTCSessionDescription({
                type: 'answer',
                sdp: message.sdpAnswer
            }));
        }

        function handleRemoteIceCandidate(message) {
            if (pc && message.candidate) {
                const candidate = new RTCIceCandidate(message.candidate);
                pc.addIceCandidate(candidate);
            }
        }

        function sendMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
            }
        }

        function stop() {
            log('Ïû¨ÏÉù Ï†ïÏßÄ...');

            if (playTimeInterval) {
                clearInterval(playTimeInterval);
                playTimeInterval = null;
            }
            playStartTime = null;
            playTimeDiv.textContent = '00:00';

            if (ws) {
                sendMessage({ id: 'stop' });
                ws.close();
                ws = null;
            }

            if (pc) {
                pc.close();
                pc = null;
            }

            videoPlayer.srcObject = null;
            connStateDiv.textContent = '-';
            iceStateDiv.textContent = '-';

            playBtn.disabled = false;
            stopBtn.disabled = true;
            setStatus('Ïó∞Í≤∞ ÏïàÎê®', 'disconnected');
            log('Ïû¨ÏÉù Ï†ïÏßÄÎê®');
        }

        window.onbeforeunload = () => {
            stop();
        };
    </script>
</body>
</html>
